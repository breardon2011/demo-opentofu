allow_draft_prs: true
auto_merge: false
pr_locks: true
telemetry: false
traverse_to_nested_projects: true

projects:
  - name: SHARED
    dir: k8s_deployment
    workflow: terraform
    include_patterns: ["*.tf", "../_env_data/shared.json", "modules/**/*.tf", "modules/**/*.yaml"]
    workspace: shared

  - name: DEV
    dir: k8s_deployment
    workflow: terraform
    include_patterns: ["*.tf", "../_env_data/dev.json", "modules/**/*.tf", "modules/**/*.yaml"]
    workspace: dev

  - name: QA
    dir: k8s_deployment
    workflow: terraform
    include_patterns: ["*.tf", "../_env_data/qa.json", "modules/**/*.tf", "modules/**/*.yaml"]
    workspace: qa

  - name: PROD
    dir: k8s_deployment
    workflow: terraform
    include_patterns: ["*.tf", "../_env_data/prod.json", "modules/**/*.tf", "modules/**/*.yaml"]
    workspace: prod

workflows:
  default:
    on_commit_to_default:
      - init
      - apply
      
  terraform:
    env_vars: 
      state:
      - name: AWS_ACCESS_KEY_ID
        value_from: DIGGER_AWS_ACCESS_KEY_ID 
      - name: AWS_SECRET_ACCESS_KEY
        value_from: DIGGER_AWS_SECRET_ACCESS_KEY
      commands:
      - name: AWS_ACCESS_KEY_ID
        value_from: AWS_ACCESS_KEY_ID
      - name: AWS_SECRET_ACCESS_KEY
        value_from: AWS_SECRET_ACCESS_KEY

    on_commit_to_default:
      - init
      - apply
    plan:
      steps:
        - init:
            extra_args: ["-backend-config=tf_backend.tfbackend"]
        - plan
    apply:
      steps:
        - init:
            extra_args: ["-backend-config=tf_backend.tfbackend"]
        - apply
        
  main:
    on_commit_to_default:
      - init
      - apply
    plan:
      steps:
        - init:
            extra_args: ["-backend-config=tf_backend.tfbackend"]
        - plan
    apply:
      steps:
        - init:
            extra_args: ["-backend-config=tf_backend.tfbackend"]
        - apply